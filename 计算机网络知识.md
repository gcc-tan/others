### 历史
[基本来自](https://www.zhihu.com/question/41496681)
计算机要交换数据，也就是通信，最简单的方式就是共享信道
两台主机的方式
`[主机A] <-------> [主机B]`
当三台及三台以上的机器需要两两通信时候
```
       [主机A]		[主机B]		[主机C]
          ^		        ^		      ^
          |		        |		      |
        _______________________________         (总线式布局)
```
在总线式网络中，主机之间要两两通信需要做什么？

1. 每个主机要有一个身份证号
这个id就是MAC地址
2. 主机需要知道其他主机的身份证号
通过ARP协议来获取其他主机的MAC地址，ARP是个2.5层的协议和第二层第三层都有关系
3. 如何在宏观上解决主机同时通信的问题？
这个在微观上来说是不能的，因为数字电信号只有一种状态，所以任何时刻只能有一个主机在发送信息，其他主机接收信息。所以就有了CSMA，载波侦听多路访问协议

假设A，B主机需要通信，那么需要知道A，B主机的MAC地址，这个可以通过广播的方式。然后A想要发送数据通过CSMA找到总线空闲期，广播发送即可，然后其他主机收到广播发现不是自己的MAC地址将数据丢弃，B发现目的地址正是B的地址即收到数据

但是很明显的可以看到这个总线的布局方式有很多缺点，第一个就是总线被占用的问题，如果两台主机一直在通信，那么总线没有空闲期这样其他主机就没办法通信。第二个就是广播的方式有风险，如果C主机不丢弃之前A广播发送的数据，伪造数据发送出去，A很难辨别是否是B发送的

结果就出现了交换机，交换机充当邮箱和邮递员的功能
```
[交                   换                     机]
(接口1           接口2          接口3       接口4)
  |                |            |            |
 主机A           主机B         主机C         主机D
```
交换机通过被动学习来知道哪个接口连接什么机器，例如A与B的通信，A发送给B数据，然后从接口1交换机收到了来自A的信件，这时候就学习到了A在接口1,之后交换机还是不知道B在哪，结果交换机就广播1接口之外的所有接口，结果2接口收到了B的响应，那么B在2接口，就通过这样的方式进行学习

交换机的出现解决了共享信道的介质争用问题，基本解决了数据被偷窥的问题，但是还是没有完全解决，因为第一次还是被交换机广播出去

为什么第三层IP层要出现？
主要就是为了局域网的互联通信。这个是因为并不是所有的局域网都是以太网，有令牌环等其他网络。以太网的地址结构是6字节，而其他网络可能是4字节的地址结构，这样两个地址结构都不同的网络是没有办法进行数据交换的。于是出现了第三层，IP层，IP是一种抽象和封装

要实现这个功能就要分两步进行

1. 首先要有一种设备能够转换两种网络帧的设备，这个设备叫做路由器。它首先出现的目的是互联异构，可以组成如下的网络
[非以太网络]<------->[路由器]<-------->[以太网]
在以太网和非以太网的眼中，路由器只是一台普通的主机罢了，以太网不知道左接口，非以太网不知道其右接口
2. 大家要相互通信必须要一个统一的地址协议，。例如中国人的名字是中文，外国人的名字是英文。然后我就统一一个名字，用阿拉伯数字。这样有了统一的地址结构就能够进行通信。
3. 从此网络中的报文就变成了如下的格式：
[二层收件人][二层发件人][三层收件人][三层发件人][数据]
4. 假设A是非以太网络中的主机，要给B以太网络的主机通信
	1. A先构造第三层的报文
	[B三层地址][A三层地址][数据]
	然后构造第二层地址的时候就尴尬了，以太网的B没有非以太网A的第二层地址，这个时候就只能写路由器的非以太网中的地址了
	[路由器左端口第二层地址][A第二层地址][B三层地址][A三层地址][数据]
	>个人感觉这个过程应该是先查路由表，确定转发接口(因为有很多主机不止是一个接口)，然后每个接口上面都有ip地址和子网掩码，两者与操作判目的地址与此接口的地址是否在同一个网段，是的话就查arp缓存查找B的ip地址对应的MAC地址，没有缓存就发送arp请求。然后封装成帧发送出去;如果不是同一个网段，查找该接口的默认网关，然后获取网管ip对应的MAC地址，过程同上，构造帧发送出去
	2. 路由器收到后解帧，看第三层的收件人地址，去查路由表，决定转发的出口，对这个帧进行改造。变成
	[B第二层地址][路由器右端口第二层地址][B三层地址][A三层地址][数据]
	3. B就正确收到了来自A的帧了


上面的过程还是留了几个问题

+ 如何判断A，B不是同一个局域网的？
IP地址由网段号加上主机号构成，同一局域网中网段号必须相同，这是规定。
+ 当A判断出与B不在同一个局域网中，A如何得知谁是路由器，要转发个哪个路由器
这些都可以通过路由表项来搞定，通过路由表项，查找目的IP对应的表项然后选择对应的外出接口
+ A是如何得知路由器的二层地址的？
通过ARP协议获取同一网段中其他主机的二层地址


所以说通过上面的介绍可以知道处于同一个网段时，两台主机并不要IP层的参与，但即使是这样，A给B发送数据依然要先封装成IP报文，然后封装成二层的帧，B收到后去掉帧头和IP头才能看到数据，之所以这么做是方便网络通信的统一性。如果在局域网中使用，可以把数据直接封装在以太网帧中，不加IP头，完全没有问题，这是和路由器完全没有关系的，但是和路由表项有关（凭什么说和B是同一个局域网中的，看路由表，直连）

### ARP Proxy
arp代理一般设置在路由器上，用来回答另一台主机的arp请求。运用在没有设定默认网关或者是路由的子网的机器和另一个子网通信。感觉这个限制很多，只能够运用在网段号相同的两个子网。因为之所以发送arp请求就是发送的主机认为目的ip是在本子网内。具体的内容可以看[这里](nice_work/代理 ARP.mhtml)













